<!DOCTYPE HTML>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="http://cdn.leafletjs.com/leaflet/v1.7.1/leaflet.js"></script>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.7.1/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
  <style>
    html,
    body {
      height: 100%;
      padding: 0;
      margin: 0;
    }

    #map {
      /* configure the size of the map */
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <script src='https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js'></script>

  <div id="map"></div>

  <script>
    // initialize Leaflet
    var map = L.map('map', {
      preferCanvas: true,
      renderer: L.canvas()
    }
    ).setView({ lon: 11.5, lat: 46.5 }, 9);

    // add the OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    }).addTo(map);

    // show the scale bar on the lower left corner
    L.control.scale().addTo(map);

    // setup markercluster group
    var clusteredMarkers = L.markerClusterGroup(
      {
        // set markercluster options; full list see https://github.com/Leaflet/Leaflet.markercluster#all-options
        showCoverageOnHover: false, // = When you mouse over a cluster it shows the bounds of its markers
        zoomToBoundsOnClick: true   // = When you click a cluster we zoom to its bounds
      }
    );

    // load CSV file
    fetch('full.csv').then(function (response) {
      return response.text();
    }).then(function (text) {

      // ugly code to parse the CSV
      // TODO: use proper parsing library!
      var lines = text.split("\n");
      for (var i = 1; i < lines.length; i++) {
        var parts = lines[i].split(";");
        let lon = parseFloat(parts[3])
        let lat = parseFloat(parts[4])

        // TODO: another ugly hack to filter out invalid coordinates and improperly parsed CSV results
        if (Number.isFinite(lon) && Number.isFinite(lat)) {

          // create marker
          var marker = L.circleMarker(L.latLng(lon, lat),
          {
            radius: 30,
            weight: 10,
            color: '#765edd',
            fillOpacity: 0.5

          });

          // ... and add it to the map
          marker.addTo(clusteredMarkers);

          // build content of a marker popup (in HTML)
          let popupContent = '<strong>' + parts[0] + '</strong><br />' + parts[1];

          // bind popup to marker
          marker.bindPopup(popupContent);

        } else {
          // console.log('Invalid coordinates');
        }
      }
    
      clusteredMarkers.addTo(map);
      // map.fitBounds(clusteredMarkers.getBounds());
    });
  </script>


</body>

</html>